<!-- ========================================== -->
<!-- âš™ï¸ WIDGET SETTINGS - ENTER YOUR IDs HERE -->
<!-- ========================================== -->
<script>
    window.NOVA_VOICE_AI_CONFIG = {
        locationId: 'YOUR_LOCATION_ID_HERE',        // E.g. uLevhyRG6...
        widgetId: 'YOUR_WIDGET_ID_HERE',            // E.g. 697ac304...
        voiceAiConfigId: 'YOUR_AGENT_ID_HERE'       // E.g. 6986aa6d...
    };
</script>

<!-- ========================================== -->
<!--             DO NOT EDIT BELOW              -->
<!-- ========================================== -->

<!-- NOVA VOICE AI WIDGET -->
<style>
    /* NOVA WIDGET STYLES */

    /* The floating launcher button */
    #nova-launcher {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #a7b5ff, #7f8bff);
        border-radius: 50%;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 10px 25px rgba(127, 139, 255, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
        animation: nova-float-launcher 4s ease-in-out infinite;
        font-family: 'Inter', sans-serif;
    }

    #nova-launcher:hover {
        transform: scale(1.05) translateY(-5px);
        box-shadow: 0 15px 30px rgba(127, 139, 255, 0.6);
    }

    .nova-chat-icon {
        font-size: 24px;
        color: white;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    /* Launcher CTA Label */
    .nova-launcher-cta {
        position: fixed;
        bottom: 105px;
        /* Above the 60px launcher (bottom:30) */
        right: 30px;
        background: white;
        color: #333;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        pointer-events: none;
        z-index: 10000;
        opacity: 1;
        transition: opacity 0.3s ease;
        animation: nova-float-launcher 4s ease-in-out infinite reverse;
        display: flex;
        align-items: center;
        font-family: 'Inter', sans-serif;
    }

    .nova-launcher-cta::after {
        content: '';
        position: absolute;
        bottom: -6px;
        right: 20px;
        /* Align arrow with launcher center */
        border-width: 6px 6px 0 6px;
        border-style: solid;
        border-color: white transparent transparent transparent;
    }

    /* Hide CTA when popup is open */
    .nova-launcher-cta.nova-hidden {
        opacity: 0;
        pointer-events: none;
    }

    /* The Widget Popup Modal */
    #nova-popup {
        position: fixed;
        bottom: 110px;
        right: 30px;
        width: 340px;
        height: 600px;
        background: #ffffff;
        border-radius: 24px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
        z-index: 9999;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transform-origin: bottom right;
        transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        transform: scale(0.9) translateY(20px);
        pointer-events: none;
        font-family: 'Inter', sans-serif;
    }

    #nova-popup.nova-open {
        opacity: 1;
        transform: scale(1) translateY(0);
        pointer-events: all;
    }

    /* Subtle gradient at the top of the popup */
    .nova-top-gradient {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 200px;
        background: radial-gradient(circle at top left, rgba(230, 230, 255, 0.8), transparent 70%);
        z-index: 0;
        pointer-events: none;
    }

    /* Top Bar: Back & Help buttons */
    .nova-header {
        position: relative;
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 20px 10px 20px;
    }

    .nova-icon-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: white;
        border: 1px solid #eaeaea;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        font-size: 16px;
        color: #333;
        transition: background 0.2s;
    }

    .nova-icon-btn:hover {
        background: #f5f5f5;
    }

    .nova-title {
        font-size: 16px;
        font-weight: 600;
        color: #111;
    }

    /* Central Orb Area */
    .nova-orb-container {
        position: relative;
        z-index: 10;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-bottom: 20px;
    }

    /* Faint dotted circle background */
    .nova-dot-bg {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -70%);
        width: 220px;
        height: 220px;
        background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
        background-size: 10px 10px;
        border-radius: 50%;
        mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 30%, rgba(0, 0, 0, 0) 70%);
        -webkit-mask-image: radial-gradient(circle, rgba(0, 0, 0, 1) 30%, rgba(0, 0, 0, 0) 70%);
        z-index: 1;
    }

    /* The Liquid Glass Orb */
    .nova-liquid-orb {
        position: relative;
        width: 140px;
        height: 140px;
        border-radius: 50%;
        /* Cleaner base gradient, less white, more purple/blue */
        background: linear-gradient(135deg, #e6e9ff 0%, #b8c5ff 50%, #90a5ff 100%);
        box-shadow:
            inset -5px -5px 15px rgba(144, 165, 255, 0.4),
            inset 5px 5px 15px rgba(255, 255, 255, 1),
            0 10px 25px rgba(144, 165, 255, 0.2);
        z-index: 2;
        overflow: hidden;
        margin-bottom: 40px;
        margin-top: -30px;
        transform: translateZ(0);
        /* Force hardware acceleration */
        transition: all 0.5s ease;
    }

    /* Internal swirling layers for glass effect */
    .nova-liquid-layer {
        position: absolute;
        width: 150%;
        height: 150%;
        border-radius: 40% 60% 60% 40% / 40% 40% 60% 60%;
        mix-blend-mode: soft-light;
        filter: blur(4px);
        opacity: 0;
        /* Hidden when dormant to keep it "clear" */
        transition: opacity 1s ease;
    }

    .nova-liquid-layer.nova-l1 {
        background: rgba(255, 255, 255, 0.9);
        top: -20%;
        left: -20%;
        animation: nova-swirl 6s infinite linear;
        animation-play-state: paused;
    }

    .nova-liquid-layer.nova-l2 {
        background: rgba(140, 150, 255, 0.8);
        bottom: -30%;
        right: -30%;
        animation: nova-swirl 8s infinite linear reverse;
        animation-play-state: paused;
        border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
    }

    .nova-liquid-layer.nova-l3 {
        background: rgba(255, 255, 255, 0.6);
        top: 10%;
        left: 10%;
        width: 80%;
        height: 80%;
        animation: nova-swirl 12s infinite linear;
        animation-play-state: paused;
        border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    }

    /* Class toggled via JS to activate the swirl */
    .nova-liquid-orb.nova-active {
        animation: nova-voice-pulse 1.5s ease-in-out infinite alternate;
    }

    .nova-liquid-orb.nova-active .nova-liquid-layer {
        opacity: 1;
        /* Fade in the internal swirls */
        animation-play-state: running;
    }

    @keyframes nova-voice-pulse {
        0% {
            transform: scale(1) translateZ(0);
            box-shadow:
                inset -5px -5px 15px rgba(144, 165, 255, 0.4),
                inset 5px 5px 15px rgba(255, 255, 255, 1),
                0 0 20px rgba(180, 150, 255, 0.6),
                0 15px 35px rgba(144, 165, 255, 0.3);
        }

        100% {
            transform: scale(1.05) translateZ(0);
            box-shadow:
                inset -5px -5px 15px rgba(144, 165, 255, 0.6),
                inset 5px 5px 15px rgba(255, 255, 255, 1),
                0 0 50px rgba(180, 150, 255, 0.9),
                0 15px 35px rgba(144, 165, 255, 0.5);
        }
    }

    @keyframes nova-swirl {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @keyframes nova-float-launcher {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-8px);
        }
    }

    /* Agent Info */
    .nova-agent-name {
        font-size: 20px;
        font-weight: 700;
        color: #111;
        margin-bottom: 6px;
    }

    /* Pagination Indicators */
    .nova-pagination {
        display: flex;
        gap: 6px;
        margin-top: 30px;
        align-items: center;
    }

    .nova-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #e0e0e0;
    }

    .nova-dot.nova-active {
        width: 16px;
        background: #222;
        border-radius: 3px;
    }

    /* Bottom Action Area */
    .nova-footer {
        padding: 24px;
        z-index: 10;
    }

    .nova-btn-start {
        width: 100%;
        padding: 16px;
        background: #1e1e1e;
        color: white;
        border: none;
        border-radius: 30px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        font-family: 'Inter', sans-serif;
    }

    .nova-btn-start:hover {
        background: #111;
        transform: translateY(-2px);
    }

    .nova-btn-start:active {
        transform: translateY(0);
    }
</style>

<!-- Google Fonts if not already loaded -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">


<!-- Launcher CTA Label -->
<div id="nova-launcher-cta" class="nova-launcher-cta">Hi..Lets Talk</div>

<!-- 1. The Launcher Bubble -->
<div id="nova-launcher" aria-label="Open Chat">
    <span class="nova-chat-icon">ðŸ’¬</span>
</div>

<!-- 2. The Popup Interface -->
<div id="nova-popup">
    <div class="nova-top-gradient"></div>

    <div class="nova-header">
        <button class="nova-icon-btn nova-close-btn" aria-label="Back">&lt;</button>
        <span class="nova-title">Hi How Can I help?</span>
        <button class="nova-icon-btn" aria-label="Help">?</button>
    </div>

    <div class="nova-orb-container">
        <div class="nova-dot-bg"></div>

        <div class="nova-liquid-orb">
            <div class="nova-liquid-layer nova-l1"></div>
            <div class="nova-liquid-layer nova-l2"></div>
            <div class="nova-liquid-layer nova-l3"></div>
        </div>

        <div class="nova-agent-name">Nova</div>

        <div class="nova-pagination">
            <div class="nova-dot nova-active"></div>
            <div class="nova-dot"></div>
            <div class="nova-dot"></div>
        </div>
    </div>

    <div class="nova-footer">
        <button class="nova-btn-start">Start a new chat</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/livekit-client@1.15.4/dist/livekit-client.umd.min.js"></script>
<script>
    (function initNovaWidget() {
        const userConfig = window.NOVA_VOICE_AI_CONFIG || {};

        const NOVA_CONFIG = {
            locationId: '',
            widgetId: '',
            voiceAiConfigId: '',
            apiEndpoint: 'https://services.leadconnectorhq.com/chat-widget/public/start-voice-ai-call/',
            livekitUrl: 'wss://retell-ai-4ihahnq7.livekit.cloud',
            ...userConfig
        };

        // Simple Interaction Logic for the Prototype
        const launcher = document.getElementById('nova-launcher');
        const ctaLabel = document.getElementById('nova-launcher-cta');
        const popup = document.getElementById('nova-popup');
        const closeBtn = document.querySelector('.nova-close-btn');
        const startBtn = document.querySelector('.nova-btn-start');

        let isPopupOpen = false;
        let isCallActive = false;
        let room = null;

        function togglePopup() {
            isPopupOpen = !isPopupOpen;
            if (isPopupOpen) {
                popup.classList.add('nova-open');
                launcher.style.transform = 'scale(0.8)';
                launcher.style.opacity = '0.7';
                ctaLabel.classList.add('nova-hidden');
            } else {
                popup.classList.remove('nova-open');
                launcher.style.transform = '';
                launcher.style.opacity = '1';
                ctaLabel.classList.remove('nova-hidden');
            }
        }

        launcher.addEventListener('click', togglePopup);
        closeBtn.addEventListener('click', togglePopup);

        // --- LiveKit Logic ---

        // Helpers
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generateMongoId() {
            const timestamp = Math.floor(Date.now() / 1000).toString(16).padStart(8, '0');
            const random = Array.from({ length: 16 }, () => Math.floor(Math.random() * 16).toString(16)).join('');
            return timestamp + random;
        }

        function generateContactId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 20; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }

        async function startCall() {
            if (!NOVA_CONFIG.locationId || !NOVA_CONFIG.widgetId || !NOVA_CONFIG.voiceAiConfigId || NOVA_CONFIG.locationId.includes('YOUR_LOCATION_ID')) {
                alert('Please configure your Location ID, Widget ID, and Agent ID in the widget snippet.');
                return;
            }

            startBtn.disabled = true;
            startBtn.innerHTML = 'Connecting to Nova...';
            startBtn.style.background = '#444';

            // Give instant visual feedback before connection completes
            document.querySelector('.nova-liquid-orb').classList.add('nova-active');

            try {
                const sessionId = generateUUID();
                const payload = {
                    contactId: generateContactId(),
                    callId: generateMongoId(),
                    widgetId: NOVA_CONFIG.widgetId,
                    locationId: NOVA_CONFIG.locationId,
                    sessionId: sessionId,
                    sessionFingerprint: generateUUID(),
                    eventData: {
                        source: 'direct',
                        referrer: document.referrer || '',
                        keyword: '',
                        adSource: '',
                        url_params: {},
                        page: { url: window.location.href, title: document.title },
                        timestamp: Date.now(),
                        campaign: '',
                        contactSessionIds: { ids: [sessionId] },
                        type: 'page-visit',
                        pageVisitType: 'text-widget',
                        domain: window.location.hostname,
                        version: 'v3',
                        parentId: '',
                        parentName: '',
                        fingerprint: null,
                        documentURL: window.location.href
                    }
                };

                const response = await fetch(NOVA_CONFIG.apiEndpoint + NOVA_CONFIG.voiceAiConfigId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': '*/*' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Server connection failed (' + response.status + ')');
                const data = await response.json();

                room = new window.LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true,
                    audioCaptureDefaults: {
                        autoGainControl: true,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                room.on(window.LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    if (track.kind === window.LivekitClient.Track.Kind.Audio) {
                        const audioElement = track.attach();
                        audioElement.setAttribute('data-voiceai-audio', 'nova-widget');
                        document.body.appendChild(audioElement);
                    }
                });

                room.on(window.LivekitClient.RoomEvent.Disconnected, () => {
                    if (isCallActive) endCall();
                });

                await room.connect(NOVA_CONFIG.livekitUrl, data.accessToken);
                await room.localParticipant.setMicrophoneEnabled(true);

                isCallActive = true;
                startBtn.disabled = false;
                startBtn.innerHTML = 'End Chat with Nova';
                startBtn.style.background = '#e11d48'; // Red hangup state

                document.querySelector('.nova-liquid-layer.nova-l1').style.animationDuration = '4s';

            } catch (error) {
                console.error('Widget Error starting call:', error);
                startBtn.innerHTML = 'Connection failed';
                document.querySelector('.nova-liquid-orb').classList.remove('nova-active');
                setTimeout(() => {
                    startBtn.disabled = false;
                    startBtn.innerHTML = 'Start a new chat';
                    startBtn.style.background = '#1e1e1e';
                }, 3000);
            }
        }

        async function endCall() {
            startBtn.disabled = true;
            startBtn.innerHTML = 'Disconnecting...';
            startBtn.style.background = '#444';

            try {
                if (room) {
                    await room.disconnect();
                    room = null;
                }

                document.querySelectorAll('[data-voiceai-audio="nova-widget"]').forEach(el => el.remove());

                isCallActive = false;
                startBtn.disabled = false;
                startBtn.innerHTML = 'Start a new chat';
                startBtn.style.background = '#1e1e1e';

                // Deactivate the orb swirl animation
                document.querySelector('.nova-liquid-orb').classList.remove('nova-active');
                document.querySelector('.nova-liquid-layer.nova-l1').style.animationDuration = '8s';

            } catch (error) {
                console.error('Widget Error ending call:', error);
                startBtn.disabled = false;
                startBtn.innerHTML = 'Start a new chat';
            }
        }

        startBtn.addEventListener('click', () => {
            if (isCallActive) {
                endCall();
            } else {
                startCall();
            }
        });

        window.addEventListener('beforeunload', () => {
            if (room && isCallActive) room.disconnect();
        });
    })();
</script>